# 7.GCP 的监测

监控是我们开发过程中最关键的阶段之一。拥有一个良好的监控系统对于获得关于我们所创建的基础设施和软件的准确反馈是至关重要的，当然，对于监督对系统的访问也是如此。在这一章中，我将讨论在谷歌云平台(GCP)中建立一个有效的监控系统的基础是什么。如果有人问:“为什么我必须使用监控系统？”你可以用这个比喻来回答:“拥有一个没有监控的大型分布式系统就像骑自行车一样，只是你在地狱，你和自行车都着火了。”

## 什么是监控系统？

给监控下一个正确的定义并不简单。例如，如果我们在谈论*软件监控*或*系统监控*，我们必须首先定义。软件监控可以定义为根据服务级别协议(SLA)的条款监控软件以确保服务质量。这通常由一组在软件上设计并由特定软件绘制的指标组成。收集并分析这些指标，以提供软件及其工作方式的图片。

系统监控可以定义为监控系统以确保机器的正确状态。这包括一组监视器和警报，用于检查服务器和网络的一般状态，以确认当前基础架构的正确功能。

基于这两个定义，我们可以建立一个共同的定义。监控是确保系统状态所必需的一套实践和软件。它由软件监控和系统监控组合而成。当我们想要创建一个监控系统时，我们必须确保准备好所有的指标和警报，以确保对系统状态的持续反馈。

根据这一定义，我们可以确定监控系统的关键要求:

*   *指标*:我们必须定义一组指标来收集关于系统当前状态的数据。

*   *Alerts* :我们必须定义一个系统，以便在指标显示不正确的值时提供警报。

*   *监控*:我们必须使用软件来采集和显示系统的实际状态。通常，这是由特定的软件完成的。

*   反馈:我们必须有积极的反馈，以防系统出错。这可以通过带有升级系统的电子邮件来提供。

这四个区域实质上是每个监控系统的核心。实时监控对于在生产中出现问题时进行调试至关重要。

有效的实时监控可以在出现问题时指示系统的实际状态，并提供系统所有状态的图像，不仅仅是软件，还包括网络、数据库、磁盘空间等。这些信息可以用来解决实际问题，更重要的是，可以用来防止同样的问题再次发生。这是因为它显示了系统失败的地方，并帮助我们确定与此相关的真正根本原因。

当我们有良好的实时监控时，我们可以很容易地识别错误，例如，当我们在软件中发布一个新特性时。我们可以看到发布的错误率，并且在我们观察到太多失败的情况下，我们可以很容易地推动代码的回滚，例如，通过使用连续交付系统(CD ),并发布软件的先前版本。

监控系统的另一个用途是预测分析。当我们有一个监控系统时，我们可以收集关于系统状态的数据。例如，基于通过 Splunk 等日志收集的这些数据，我们可以开始进行一些预测性分析。假设我们有一个显示 CPU 使用情况的图表(见图 [7-1](#Fig1) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig1_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig1_HTML.jpg)

图 7-1

一个样本记忆图

上图显示了不同时间的 CPU 使用情况。我们可以看到一些尖峰和一些正常的用法。可以为不同的时间范围创建相同的图表，例如，天、周和月。该图表可以显示不同数据框的使用情况。此信息可用于执行计算，并确定我们的基础架构使用的最繁忙时段。

一个好的监控系统有助于我们识别这一时段，然后调整软件和基础设施，以更好地应对最繁忙的时段。此外，它还提供了有关系统历史性能的信息，当我们必须在基础架构中部署新服务器时，可以帮助我们校准和确定我们的需求。这转化为成本节约和更好地识别系统中的任何瓶颈。

当我们考虑监控时，我们可以识别两种类型:白盒监控和黑盒监控。白盒监控为我们提供了应用内部状态的详细信息，例如 HTTP 连接、数量或用户等。另一方面，黑盒监控从外部检查系统的运行情况。黑盒并没有给出关于 HTTP 连接数或实际连接到系统的用户数的信息。

白盒监控的一个好例子是 Prometheus，黑盒监控的一个好例子是 Nagios。我们可以使用这两种类型，来建立一个良好而强大的监控系统。

### 监控系统中涉及的因素

当我们考虑建立我们的监控系统时，我们必须考虑一些关键因素。我们必须做出的第一个假设是，监控没有明确的定义。但是，我们可以找出一些与监控系统相关的常用术语。

*   *监控*:我之前已经定义了监控，但是，总结一下，它可以被定义为收集、处理、聚集和显示关于系统、错误、服务器生命周期、用户连接、已用空间等的实时信息。

*   *白盒监控*:这种类型的监控是对系统暴露给外部的内部指标的监控。白盒监控的一个例子是记录服务以检查软件是否是活动的，例如 HTTP 检查，以及可以用于查看系统内部的任何其他服务。

*   *黑盒监控*:这是一种从系统外部执行的监控，例如，监控一个应用。与白盒监控相反，它用于检查系统本身生成的日志。使用黑盒监控，我们并不真正检查日志，而是检查服务的输出，例如，检查服务是否是活动的。

*   *仪表板*:仪表板本质上是一个图形用户界面(GUI)，用于指示系统的状态。这通常是一个 web 应用。仪表板通常允许用户过滤或搜索系统上的特定资源。

*   *警报*:警报是监控系统对特定情况的反应，例如，当我们有高 CPU 使用率或磁盘空间问题时。可以通过不同的方式发出警报。例如，我们可以有一个*标签提醒*，这意味着当系统发现一个问题时，一个标签被创建并直接分配给一个团队，或者一个*邮件提醒*，在这种情况下，系统在检测到一个问题时会向一个特定的邮件列表发送一封电子邮件。

*   *根本原因*:根本原因本质上是问题的主要来源。确定问题的根本原因对于系统的稳定性是必不可少的，一个好的监控系统可以很容易地确定原因并发出新的警报以防止问题再次发生。

*   *节点/机器*:这个术语表示发生错误的物理或虚拟硬件。每个节点或机器都可以运行多个服务，一个警报可以连接到每个服务器。

*   *推送*:这是软件的一个发布，由自动系统制作，比如木偶或者厨师。

*   *回滚*:这是发布旧版本软件使系统再次稳定所遵循的程序。这通常是通过在系统中推送旧版本的软件来完成的。

这个术语在所有监控系统中都是通用的，通常用来描述我们为解决系统问题而采取的操作。

### 为什么监控很重要

监控很重要，原因有很多，不仅是为了确保系统本身的稳定性。例如，监控系统可用于以下用途:

*   *时间分析*:监控系统可用于观察系统基础设施的关键方面。例如，我们可以收集有关数据库增长的数据，或者我们可以确定数据库在一年或一个月中最活跃的时间。同样，我们可以在不同的版本中衡量我们软件的质量。

*   *比较数据*:使用监控系统，我们可以从一个系统收集数据，并与另一个系统进行比较。这些数据可以用来决定什么样的软件更适合我们的需求。

*   *警报*:如前所述，监控系统用于在系统出现错误时发出警报。监控系统检查系统的状态，并在出现错误的情况下发出警报。

*   *可视化系统状态*:当我们有一个监控系统时，我们通常有一个仪表板来可视化系统的当前状态。监控系统提供了整个系统的清晰画面。

*   *调试*:一个监控系统是基于日志分析的，这意味着我们可以使用系统来分析软件在特定时间的状态，看看是否有任何特定的条件导致了特定的错误。

以上是使用良好的监控系统来确保安全的一些最常见的原因。我们可以监控对系统的访问，并使用这些信息来防止数据泄露。一个好的监控系统必须回答两个简单的问题:

*   什么坏了？

*   为什么坏了？

每个监控系统都必须回答这两个问题，才能真正有效。

#### 什么坏了，为什么？

一个良好和有效的监测系统必须能够给我们这些简单问题的答案。首先要确定*什么*坏了。这是对系统中工作不正常的组件的识别。这是监控系统的基础。

监控系统必须找到的第二个答案是，为什么它会坏？这个问题的答案更复杂，因为它涉及到误差分析。一个好的监测系统可以帮助我们做到这一点，因为它给我们一个系统状态的实际画面。

表 [7-1](#Tab1) 显示了每个系统中可能出现的两种常见错误。我们可以看到“什么”是错误的*症状*和*原因*的结果。一个良好有效的监控系统必须能够识别*什么*并向工程团队发出警报，以开始分析并识别故障的*原因*。

表 7-1

什么可能被破坏以及为什么会被破坏的例子

<colgroup><col class="tcol1 align-left"> <col class="tcol2 align-left"></colgroup> 
| 

什么

 | 

为什么

 |
| --- | --- |
| 网站显示有一个 505。 | 我们用来获取数据的网络服务关闭了，我们无法访问它。 |
| FPT 失败。 | 磁盘已满，文件无法上传。 |

## 白盒和黑盒监控

正如我前面提到的，有两种系统监控:白盒和黑盒监控。白盒监控可以在所有软件和系统上执行，并且可以设置为显示软件的内部状态。通过白盒监控，我们使用软件在操作系统级别检查系统。白盒监控与基础设施没有直接关系。例如，我们可以使用的白盒监控软件有 Prometheus、Nagios、Zabbix 和 Splunk。所有这些软件都用于检查基础设施的状态，并直接显示出来。

相反，黑盒监控通过使用指标来检查系统。将系统视为一个黑盒意味着我们可以直接窥视软件内部，但是基于由一些相关度量定义的统计。黑盒监控软件包括 Prometheus、Nagios 和 Splunk。

我们可以把黑盒监控看作是告诉我们出了什么问题，但不是以一种预测的方式。黑盒监控指示问题何时出现，但没有给我们一种方法来预测问题何时会出现。

白盒监控基于对系统实际状态的检查。这意味着我们可以使用收集的数据。例如，我们可以使用 Splunk 来分析日志，并查看何时存在导致潜在问题的条件。

白盒监控直接检查操作系统，并识别可用于调试或识别问题原因的任何条件或指标，允许用户防止问题发生。例如，通过白盒，我们可以看到系统何时开始使用过多的内存，这会降低系统的速度。

我们可以将一条黄金法则应用于监控系统。它定义了四个黄金信号，我们可以用它们来了解系统。这些信号是:

*   潜伏

*   交通

*   错误

*   浸透

每个信号用于描述一种不一定与错误相关但可能导致后续错误的情况。

### 潜伏

延迟是我们为请求提供服务所需的时间。高延迟并不总是一个问题，但它可能表明系统响应缓慢，在某些情况下，这可能会导致错误。通过监控系统的正常时间响应来识别何时存在延迟问题并更快地修复问题，从而防止错误是很重要的。

### 交通

流量不是一个实际的错误，但它可以用来理解如何扩展我们的系统以避免问题或故障。交通测量系统有多少需求。我们可以设置不同的高级度量来定义这一点，例如每秒请求多少页面或者我们的服务器每秒接收多少请求。根据我们必须监控的系统的性质，可以采用这种方法。

### 错误

当我们度量一个错误时，我们不仅要确定明显的错误，比如 500 内部服务器错误或 NullPointerException，还要确定函数是否完成了任何工作，比如返回 200 错误但具有不同内容(比如不同数据)的页面。跟踪这两种情况非常重要。通常，监控系统只跟踪明显的错误情况，但一个非常好的监控系统也可以跟踪部分错误情况，如 200 错误，以及任何导致的错误数据。

### 浸透

饱和度用来衡量我们的系统有多“满”。我们通常使用不同的指标来确定饱和度，例如内存、文件系统、网络和 I/O 流水线。饱和度可以用于预测性分析，因为，例如，我们可以使用这个度量来了解我们必须使数据库或文件系统饱和多少次。在一个复杂的系统中，确定价值并不容易，因为资源 10%的改进可能会降低整个系统的速度。拥有测量饱和度的有效方法对于防止我们系统中的严重错误非常重要。

监测所有这四个信号是建立一个非常好和有效的监测系统的良好开端。

### 建立一个监控系统

到目前为止，我们已经分析了监控系统必须包括的内容以及系统中可能识别的内容。我们现在必须做的是定义构建我们的监控系统所需的要求和软件。想象一下，我们想从头开始构建我们的监控系统。我们必须考虑我们系统的主要组件，例如:

*   *OS 监控*:我们必须定义一套脚本来与一个非常好且有效的监控器交互。对于每一项措施，我们都可以通过电子邮件发出警报，迅速采取行动，防止类似问题的发生。操作系统可以提供关于系统状态的反馈。

*   *日志分析*:我们必须有能力读取日志，识别软件中的错误并收集数据。

*   *警报*:我们必须有能力发送电子邮件或连接到一些外部软件，以跟踪系统中发生的任何错误。

*   *仪表板*:为了系统的可视化表示，并获得可观察的分析，可以设计一个与软件一起使用的仪表板，我们可以使用仪表板来获得实际系统的图像。

*   *软件集成*:我们必须设计一些第三方集成来使用和连接我们的软件，以及一些外部警报或数据分析系统。

*   *监控四个信号*:要有一个非常好且有效的监控系统，我们必须监控所有四个信号——延迟、流量、错误和饱和度。当我们监控这些信号并发出适当的警报时——如果其中一个信号显示异常——我们就有了一个非常有效的监控系统的基础。

前面的要点实质上是我们系统的主要需求。我们可以从头开始构建系统，或者使用一些现有的软件来执行监控。GCP 有一个名为 *Stackdriver 的综合监控系统。*因此，让我们开始使用 Stackdriver 来监控我们的云。

## 在 GCP 上配置堆栈驱动程序

谷歌云为创建监控系统提供了自己的解决方案。它被称为 Stackdriver，能够在一个地方监控所有云应用。基于我们所拥有的服务，可以创建图表并添加我们想要的信号。

Stackdriver 提供了与一些用于我们应用的常用软件的各种集成，如 NGINX、Cassandra、Apache 和 Elasticsearch。Stackdriver 生成的警报可以直接发送到警报软件，如 PagerDuty，或者 chat，如 Slack 或 HipChat。

要在我们的 GCP 中使用 Stackdriver，第一步是创建一个帐户。为此，只需连接到 GCP 控制台，打开左侧菜单，并在 Stackdriver 部分选择 Monitoring(参见图 [7-2](#Fig2) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig2_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig2_HTML.jpg)

图 7-2

GCP 的菜单

当监控板打开时，它会要求选择我们想要监控的项目，如果是第一次，还会提醒我们开始 30 天的免费试用(图 [7-3](#Fig3) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig3_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig3_HTML.jpg)

图 7-3

堆栈驱动程序监控部分

要启动 Stackdriver，请选择项目 PracticalDevOpsGCP，然后单击 CreateAccount 按钮。在我们的例子中，当帐户被创建时，它与我们的 GCP 相关联。

下一步是在 Stackdriver 下关联我们想要监控的项目。在我们的例子中，我们可以看到两个项目呈现在我们的云中。第一个选择如图 [7-4](#Fig4) 所示。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig4_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig4_HTML.jpg)

图 7-4

添加要监视的项目的 Stackdriver 部分

向下滚动页面，然后单击继续。这将打开配置 Stackdriver 的下一页。下一页要求配置 AWS 帐户。我们可以跳过这一部分，因为这对我们的目的来说是不必要的。

最后一部分用于配置 Stackdriver 代理。本页显示了配置客户端必须执行的命令。代理运行在我们的云实例中，收集我们部署监控系统所需的所有信息(图 [7-5](#Fig5) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig5_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig5_HTML.jpg)

图 7-5

在我们的平台中配置 Stackdriver 客户端的命令

要配置客户端，请打开命令行并执行配置客户端所需的命令。我们必须执行的第一个命令是`curl`，下载安装客户端所需的脚本。

```
curl -sSO https://dl.google.com/cloudagents/install-monitoring-agent.sh

```

文件非常小，命令会立即返回。我们执行的下一个命令是安装客户机的命令。

```
sudo bash install-monitoring-agent.sh

```

该脚本返回安装的输出，但是我们必须注意的部分是脚本的最后一行，在那里我们可以找到安装的状态。

```
Created new plugin context.
option = PIDFile; value = /var/run/stackdriver-agent.pid;
option = Interval; value = 60.000000;
option = Hostname; value = ;option = FQDNLookup; value = false;
Created new plugin context..
===========================================================================
Installation of stackdriver-agent-5.5.2-382 completed successfully.
Please consult the documentation for troubleshooting advice:
https://cloud.google.com/monitoring/agent
You can monitor the monitoring agent's logfile at:
       /var/log/syslog
===========================================================================

```

现在安装已经成功完成，我们已经正确安装了 Stackdriver 监控客户端。要完成 Stackdriver 的安装，我们必须安装日志客户端。该客户端用于从虚拟机和其他第三方软件传输日志。这可用于识别与读取应用日志相关的问题。要安装日志客户端，我们首先必须下载安装它所需的脚本。

```
curl -sSO https://dl.google.com/cloudagents/install-logging-agent.sh

```

当脚本下载后，我们现在可以执行脚本来安装客户端。

```
sudo bash install-logging-agent.sh

```

与其他脚本一样，这个脚本返回脚本的状态，但是对我们来说，重要的是脚本的最后部分，在那里我们可以看到安装的状态(清单 [7-1](#PC6) )。

```
Installing default conffile /etc/google-fluentd/google-fluentd.conf ...
invoke-rc.d: could not determine current runlevel
invoke-rc.d: policy-rc.d denied execution of start.
Setting up google-fluentd-catch-all-config (0.7) ...
Restarting google-fluentd: google-fluentd.
===========================================================================
Installation of google-fluentd complete.
Logs from this machine should be visible in the log viewer at:
  https://console.cloud.google.com/logs/viewer?project=&resource=gce_instance/instance_id/6349597365373579285
A test message has been sent to syslog to help verify proper operation.
Please consult the documentation for troubleshooting advice:
  https://cloud.google.com/logging/docs/agent
You can monitor the logging agent's logfile at:
  /var/log/google-fluentd/google-fluentd.log
===========================================================================

Listing 7-1The Result of Logging the Stackdriver Client Installation

```

既然我们已经正确地安装了 Stackdriver 日志记录客户机，现在我们已经拥有了开始部署我们的监控系统所需的所有客户机。

### 创建应用

现在我们已经配置并安装了 Stackdriver 的所有必要元素，我们可以开始看看 Stackdriver 是如何工作的。仅出于演示目的，我们在 GCP 用 Apache CloudStack 创建了一个新的 PHP 7，并看看我们如何监控该系统。

我们采取的第一步是创建一个新的计算引擎实例。为此，我们必须打开控制台并创建计算引擎。我们可以通过单击“创建新实例”弹出窗口中的“创建”按钮来创建实例。这显示了我们需要为新实例插入的细节(图 [7-6](#Fig6) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig6_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig6_HTML.jpg)

图 7-6

用于创建我们想要监视的新实例的页面

因为该实例主要用于展示监控如何与 GCP 一起工作，所以我们将该实例称为 *stackdriverinstance* 。选择一个小实例，允许 HTTP 和 HTTPS 流量，将其余文件保留为默认细节，然后点击创建，创建实例(图 [7-7](#Fig7) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig7_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig7_HTML.jpg)

图 7-7

在 GCP 上创建的 Stackdriver 实例

创建了实例后，我们现在必须安装想要监控的软件。为此，我们打开一个 SSH shell，连接到实例。我们只需点击 SSH 标签就可以做到这一点。我建议打开一个新的浏览器，因为这会直接在我们的 VM 实例上打开一个 shell(清单 [7-2](#PC7) )。

```
Connected, host fingerprint: ssh-rsa 2048 3A:76:C8:B9:E5:0C:9B:30:BF:47:B5:92:9C:23:CA:88:BA:09:4E:76:48:39:C5:32:D0:C9:0B:37:94:6D:C4:15
Linux stackdriverinstance 4.9.0-7-amd64 #1 SMP Debian 4.9.110-3+deb9u2 (2018-08-13) x86_64
The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.
Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
pierluigi_riti@stackdriverinstance:~$

Listing 7-2The SSH Connection with the New Instance Created

```

有了对实例的访问，我们现在必须做的是安装软件。我们想安装 PHP 7 和 Apache HTTP web 服务器。因此，我们需要执行的第一个命令是更新库。我们选择 Debian 操作系统，因此更新库的命令是

```
sudo apt-get update

```

此命令生成输出，其中包含从系统更新的程序包列表。命令完成后，我们现在必须安装 PHP 7 和 Apache Web 服务器。为此，我们使用以下命令:

```
sudo apt-get install apache2 php7.0

```

软件开始检查安装所需的软件包，并要求我们确认软件的安装。点击 Y，软件继续安装(列表 [7-3](#PC10) )。

```
pierluigi_riti@stackdriverinstance:~$ sudo apt-get install apache2 php7.0
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following additional packages will be installed:
  apache2-bin apache2-data apache2-utils libapache2-mod-php7.0 libapr1 libaprutil1 libaprutil1-dbd-sqlite3
  libaprutil1-ldap libicu57 liblua5.2-0 libperl5.24 libxml2 perl perl-modules-5.24 php-common php7.0-cli
  php7.0-common php7.0-json php7.0-opcache php7.0-readline psmisc rename sgml-base ssl-cert xml-core
Suggested packages:
  www-browser apache2-doc apache2-suexec-pristine | apache2-suexec-custom php-pear perl-doc
  libterm-readline-gnu-perl | libterm-readline-perl-perl make sgml-base-doc openssl-blacklist debhelper
The following NEW packages will be installed:
  apache2 apache2-bin apache2-data apache2-utils libapache2-mod-php7.0 libapr1 libaprutil1
  libaprutil1-dbd-sqlite3 libaprutil1-ldap libicu57 liblua5.2-0 libperl5.24 libxml2 perl perl-modules-5.24
  php-common php7.0 php7.0-cli php7.0-common php7.0-json php7.0-opcache php7.0-readline psmisc rename sgml-base
  ssl-cert xml-core

0 upgraded, 27 newly installed, 0 to remove and 0 not upgraded.
Need to get 21.0 MB of archives.
After this operation, 95.1 MB of additional disk space will be used.
Do you want to continue? [Y/n]

Listing 7-3The PHP-Apache Installation Package

```

安装软件后，我们现在可以检查服务器是否有响应。为了连接到服务器，我们可以使用链接`http://<external_ip>`。在我这里，链接是`http://35.227.27.47/`。这显示了 Apache HTTP 服务器的默认页面(图 [7-8](#Fig8) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig8_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig8_HTML.jpg)

图 7-8

Apache HTTP 服务器默认页面

### 使用 Stackdriver 进行日志分析

配置好 Stackdriver 和我们想要监控的应用后，我们现在可以开始了解 Stackdriver 是如何工作的。我们之前已经为 Stackdriver 安装了日志客户端。这意味着我们可以直接从计算引擎页面查看应用的日志。要访问日志，单击实例名称附近的三个点并选择查看日志(图 [7-9](#Fig9) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig9_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig9_HTML.jpg)

图 7-9

查看新实例的日志命令

查看日志打开 Stackdriver 的日志仪表板(图 [7-10](#Fig10) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig10_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig10_HTML.jpg)

图 7-10

Stackdriver 的日志仪表板

Stackdriver 是一个非常成熟的监控系统，logging dashboard 为我们提供了许多工具来进行分析。为了帮助分析日志，我们可以对我们选择查看的日志应用一些过滤器。

我们可以使用左边的第一个下拉菜单来更改我们想要分析的日志。我们可以选择想要分析哪种日志。例如，我们可以基于这些日志家族来读取日志:防火墙规则、项目、VM 实例和存储桶。这些只是不同种类原木的例子。对于每个部分，我们可以有子详细日志。例如，在 VM 实例的情况下，我们可以选择我们系统中的所有实例(图 [7-11](#Fig11) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig11_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig11_HTML.jpg)

图 7-11

虚拟机实例子菜单

我们可以改变我们想要分析的日志类型，基于我们的选择，我们可以有更多的子菜单。这有助于我们对系统进行非常详细的分析。

我们可以添加另一个过滤器。例如，我们可以从菜单上的选项中选择想要读取的日志。默认情况下，我们看到“所有日志”，但是如果我们更改我们看到的日志，我们可以添加另一个过滤器。例如，我们可以选择只查看错误或调试信息。我们还可以添加一个时间过滤器。我们可以选择只查看最后一小时的日志。我们可以添加一个文本过滤器，在日志中进行自由文本搜索。

我们可以使用过滤器来分析日志和调试应用。我们可以使用过滤器来追溯时间，使用日志仪表板来分析和确定错误的根本原因。

### 堆栈驱动程序中的警报

没有好的警报系统，就不可能有好的监控系统。要在 Stackdriver 中创建警报，请打开 Stackdriver 部分中的 Monitor 页面。这显示了用于在 Stackdriver 中创建警报和管理警报策略的仪表板(图 [7-12](#Fig12) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig12_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig12_HTML.jpg)

图 7-12

Stackdriver 监控仪表板

我们可以看到，我们已经创建了一些与应用相关的基本警报。我们想要创建的基本警报是正常运行时间，以了解应用是否是活动的。

要创建正常运行时间警报，我们必须首先创建一个监视器。为此，我们从监控正常运行时间下的控制面板创建检查中进行选择。这将打开警报的配置页面。我们可以在支票上配置不同的参数。我们可以设置警报的标题，在我们的例子中是*practicaldevopsgcp _ uptime*，以及我们想要的检查类型。我们可以选择三种不同的类型:

*   超文本传送协议

*   安全超文本传输协议

*   三氯苯酚

在我们的例子中，我们使用 HTTP 类型。这是因为我们要检查的实例响应 HTTP 链接。为了有效，警报必须知道要检查什么类型的资源。这可以在资源类型部分进行配置。我们可以选择以下类型之一:

*   情况

*   云负载平衡器

*   应用引擎

*   统一资源定位器

因为我们想要监视一个实例，所以我们选择 instance。现在，我们可以选择将哪个实例应用于警报，以及是只应用于单个实例还是一组实例。我们可以在“应用于”部分进行配置。为了有效，警报必须在一定时间后检查系统。我们可以在“检查频率”部分进行配置。默认情况下，检查每五分钟开始一次。我们可以简单地通过从下拉菜单中选择不同的时间来改变这个时间间隔。现在，我们已经为警报设置了所有值，我们可以保存警报并开始监控我们的系统。我们可以测试警报，看看它是否正常工作。要测试它，我们只需点击测试按钮。这显示了操作的结果(图 [7-13](#Fig13) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig13_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig13_HTML.jpg)

图 7-13

我们创建的警报的测试结果

我们可以看到测试被成功执行，结果是 a 200。这意味着警报可以到达我们想要监控的实例和服务。

### 策略警报配置

我们现在有一个警报来检查我们系统的状态。警报本身并没有多大用处。这是因为拦截它需要一个人站在仪表板前，看警报何时发出。

我们可以将警报与特定的策略警报相关联。策略警报用于通知人们系统中发生了错误。例如，我们可以发送电子邮件或在 HipChat 聊天室中添加通知，或者我们可以通过单击“创建警报策略”按钮来创建策略警报。这将显示一个页面，我们可以在该页面上配置我们的策略。我们可以配置策略的四个方面。

*   情况

*   通知

*   文件

*   名字

该页面允许我们为策略创建特定的值。第一部分是条件。条件是我们可以做出的所有选择来产生警报。我们可以选择四种类型来创建警报。

*   *基本类型*:在这个部分，我们可以为我们的警报选择一些基本值。我们还可以指定一个指标阈值，例如 CPU 使用率或磁盘 I/O 读写。我们可以指出阈值的值，以及它是否必须高于或低于该阈值以及持续多长时间。我们可以设置的另一个条件是缺少度量标准。例如，如果我们在 30 分钟内没有任何 CPU 使用，我们可以发出警报。

*   *高级类型*:该指标用于定义特定时间范围内资源使用的增加或减少。例如，它可以用于查看资源使用量的增加情况，并相应地进行放大或缩小。

*   基本健康状况(Basic Health):这个指标用于对服务的正常运行时间进行基本检查。我们使用之前创建的警报来配置此条件。

*   *高级健康*:用于检查实例上的进程。我们可以指定要检查的流程以及它的存活时间。

下一部分是通知。这用于向人发送警报以供处理或确认。基本通知是电子邮件。这意味着我们向我们配置的特定收件人发送电子邮件。在监控系统中，这种电子邮件可以发送给一个组。这样，该组的所有成员都会收到警报并可以解决它。

文档是一个字段，我们可以用它来记录我们想要的警报类型。为警报定义良好的文档非常重要。我们可以使用一些标记来创建与警报相关的文档。

最后一部分是策略的名称，本质上就是策略的名称。

我们现在可以为之前创建的警报创建策略。在“monitoring”部分，我们创建了一个新的策略警报。我们为正常运行时间创建了策略，但是我们必须创建一个基本的健康检查，以便在出现错误时通过电子邮件通知。我们选择基本健康状况和我们想要监控的实例。我们将一封电子邮件连接到通知部分，添加一些文档，给出一个名称，然后保存。现在我们有了一个与警报相关的策略。

### 创建仪表板

监控系统的一个基本组件是一个仪表板，用于图形化显示我们的系统。这用于获得系统状态的清晰和即时的概念。

要在 Stackdriver 中创建仪表板，我们选择仪表板，然后选择创建仪表板。这将把我们带到一个空白仪表板，我们可以用它来创建我们的个人仪表板(图 [7-14](#Fig14) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig14_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig14_HTML.jpg)

图 7-14

我们用来创建个人仪表板的空白仪表板

第一步是更改仪表板的名称。我们可以简单地更改名称，只需单击无标题仪表板，然后为仪表板配置我们想要的名称，在我的例子中，是 Stackdriver GCP 仪表板。我们可以通过单击 ADD CHART 按钮来添加第一个图表。这将打开创建第一个图表的页面。首先，我们必须创建想要添加到图表中的资源。当我们单击 Find Resource type and metrics 文本框时，页面会显示一个下拉框，从中我们可以开始选择要添加到图表中的资源类型。在我们的例子中，我们添加了一个 GCE VM 实例。之后，我们可以选择想要监控的指标。在我们的案例中，我们选择正常运行时间。点击保存按钮创建图表(参见图 [7-15](#Fig15) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig15_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig15_HTML.jpg)

图 7-15

“添加图表”页面

我们现在已经创建了第一个图表。我们可以在仪表板上添加另一个图表。如果我们想要添加 CPU 负载平均值，我们可以重复刚才的步骤，但是在这个实例中，我们检查指标 CPU 使用率。仪表板将如图 [7-16](#Fig16) 所示。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig16_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig16_HTML.jpg)

图 7-16

有两个监视器的仪表板

### 测试仪表板

现在我们已经有了我们的监控系统，我们必须确保它正常工作。因此，我们停止我们的实例，五分钟后，检查警报是否被正确发出。停止实例，看看发生了什么。当检查的时间到来时，我们可以看到仪表板揭示了事件(图 [7-17](#Fig17) )。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig17_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig17_HTML.jpg)

图 7-17

仪表板显示正常运行时间的错误

因为我们设置了电子邮件提醒，所以我们会收到一条消息，告诉我们此时正在发生的事件。该消息如图 [7-18](#Fig18) 所示。

![../images/464715_1_En_7_Chapter/464715_1_En_7_Fig18_HTML.jpg](../images/464715_1_En_7_Chapter/464715_1_En_7_Fig18_HTML.jpg)

图 7-18

策略警报发送的邮件

监控系统显示错误，并通知人们系统中发生了错误。我们现在已经在 GCP 建立了第一个监测系统。

## 结论

创建一个良好的监控系统对于我们的 DevOps 取得良好的结果至关重要。建立一个好的监控系统并不容易。它需要经验和耐心观察我们的软件。监控系统的主要目标是识别出现的任何错误并对其做出反应，并且可能用于调试生产中的错误。有很多软件可以用来创建我们自己的监控系统。在本章中，我们使用 Google 提供的解决方案 Stackdriver 来监控 GCP。监控是一个非常大的领域，在这一章中，我们看到了可以用来设计系统的常用技术。所有的技术都可以适应你最喜欢的软件。监控的重要部分是其背后的理论和警报系统。