Two

描述 Docker 的最佳方式是使用 Docker 网站上的短语——Docker 是“一个开源项目，可以将任何应用程序作为轻量级容器打包、运输和运行。”因此，Docker 的想法是拥有一个抽象层，允许应用程序开发人员打包任何应用程序，然后让容器化技术负责任何基础架构的部署。

Docker 类似于海运集装箱，你可以将货物装入标准化的集装箱中，然后毫不费力地运送到不同的地点。标准化集装箱的出现使得运输变得快速和灵活。Docker 对应用程序也是如此。

开发人员和系统管理员可以使用 Docker 平台来开发应用程序并将其发布到不同的环境中。应用程序的解耦部分可以被集成并非常快速地交付到生产环境中。

例如，开发人员可以在 Docker 容器中安装和配置应用程序，将其传递给运营人员，他可以将它部署到任何运行 Docker 的服务器上。应用程序将完全像在开发人员的笔记本电脑上运行一样运行。

Docker 的这一惊人特性极大地节省了部署应用程序所花费的时间和精力，确保了依赖关系的可用性，并解决了部署中与依赖关系和冲突相关的问题。

Docker 技术非常适合部署在云上的应用程序，因为它使它们的迁移更加简单和快速。

Docker 利用了 LXC (Linux Containers)，它包含了 cgroups 和 namespaces 等 Linux 特性，以实现强大的进程隔离和资源控制。然而，值得注意的是，Docker 并不局限于 LXC，而是可以在未来使用任何其他容器技术，随着新版本的发布，他们现在支持 libcontainer。

Docker 利用了写时复制文件系统，这允许 Docker 快速实例化容器，因为它利用了指向现有文件的指针。写入时复制文件系统还提供容器分层，因此您可以创建一个基本容器，然后拥有基于该基本容器的另一个容器。

Docker 使用“纯文本”配置语言来定义和控制应用程序容器的配置。这个配置文件称为 DockerFile。

Docker 利用 Linux 内核设施，如 [cGroups](https://www.kernel.org/doc/Documentation/cgroups/cgroups.txt) 、名称空间和 [SElinux](http://selinuxproject.org/page/Main_Page) 来提供容器之间的隔离。起初 Docker 是 [LXC](https://linuxcontainers.org/) 容器管理子系统的前端，但是 0.9 版本引入了 [libcontainer](http://blog.docker.com/2014/03/docker-0-9-introducing-execution-drivers-and-libcontainer/) ，这是一个本地 Go 语言库，提供了用户空间和内核之间的接口。

容器位于联合文件系统之上，如 [AUFS](http://aufs.sourceforge.net/aufs.html) ，它允许跨多个容器共享组件，如操作系统映像和已安装的库。

容器从一个映像开始，该映像可以是本地创建的、本地缓存的或从注册表下载的。Docker Inc .运营着 [Docker Hub 公共注册中心](https://registry.hub.docker.com/)，它托管着各种操作系统、中间件和数据库的官方存储库。

大多数 linux 应用程序可以在 Docker 容器中运行，容器从映像启动，运行的容器可以转换成映像。有两种方法可以为 containers Manual 和 Dockerfile 创建应用程序包。

手动构建

手动构建从启动带有基本操作系统映像的容器开始。执行在操作系统上安装应用程序的正常过程，并且一旦应用程序被安装，容器可以被导出到 tar 文件或者可以被推送到像 Docker Hub 这样的注册表。

Dockerfile

对于 Docker 容器的构造，这种方法更加脚本化和自动化。Dockerfile 指定要启动的基本映像，然后顶层的其他安装被定义为一系列运行的命令或添加到容器中的文件。

other 文件还可以指定容器配置的其他方面，例如端口、启动时运行的默认命令等。与手动方法类似，Docker 文件可以导出，Docker Hub 可以使用自动构建系统从 Docker 文件构建映像。

让我们来看看使 Docker 对应用程序开发人员和基础设施管理员有用且有吸引力的几个特性:

便携式部署:

由于容器是可移植的，所以应用程序可以捆绑到一个单元中，并且可以部署到各种环境中，而无需对容器进行任何更改。

快速应用交付:

Docker 容器的工作流程使开发人员、系统管理员、QA 和发布团队能够轻松协作，并快速将应用程序部署到生产环境中。

由于采用了标准的容器格式，开发人员只需担心容器内运行的应用程序，系统管理员只需担心将容器部署到服务器上。这种良好分离的 Docker 管理导致更快的应用交付。

图 2-1: Docker 应用交付和部署

![](../images/00011.jpeg)

此外，建造新的集装箱速度很快，因为集装箱重量很轻，建造一个新的集装箱只需几秒钟。这反过来减少了测试、开发和部署的时间。此外，容器可以在迭代中构建，因此可以很好地了解最终应用程序是如何构建的。

Docker 对于开发生命周期非常有用。Docker 容器可以在开发人员的笔记本电脑中构建和打包，并且可以与持续集成和部署工具集成。

例如，当开发人员将一个应用程序打包到一个容器中时，它可以在其他团队成员之间共享。之后，它可以被推到测试环境中进行各种测试。从测试环境中，您可以将所有经过测试的容器推到生产环境中。

轻松扩展和部署:

Docker 容器几乎可以在任何 Linux 系统上运行。容器可以部署在云环境、桌面、本地数据中心、物理服务器等等。您可以轻松快速地将容器从桌面环境移至云环境，然后再移回物理服务器。

关于容器的另一个有趣的因素是可伸缩性。放大和缩小容器的速度快得惊人。你可以把容器从一个扩大到一百个，不需要的时候再缩小。因此，Docker 容器非常适合为公共云平台构建的横向扩展应用程序。

更高密度的更高工作负载:

图 2-2:虚拟机与 Docker 容器

![](../images/00012.jpeg)

与虚拟机相比，可以在主机上部署更多的容器应用程序。由于 Docker 不需要使用管理程序，因此可以很好地利用服务器资源，并且可以降低额外服务器资源的成本。因为 Docker 容器不使用完整的操作系统，所以与虚拟机相比，资源需求较少。

![](../images/00004.jpeg)少数使用案例

1.应用程序可以通过构建流水线轻松部署在服务器上。

2.可在带有 Mesos 或 Kunbernetes 的生产环境中使用，以实现应用程序高可用性和更好的资源利用率。

3.易于在开发人员的工作站中克隆生产环境。

4.通过投放集装箱进行负载/规模测试。

Docker 有客户端服务器架构。它有一个 Docker 客户端和一个 Docker 守护进程。Docker 客户机指示 Docker 守护进程执行所有容器特定的任务。Docker 客户机和 Docker 守护进程之间的通信是通过套接字或 REST API 实现的。Docker 守护进程根据来自 Docker 客户端的指令创建运行并分发容器。Docker 客户端和 Docker 守护进程可以在同一台主机上，也可以在不同的主机上。

![](../images/00013.jpeg)

图 2-3: Docker 架构

坞站守护程序:

Docker 守护进程负责所有的容器操作。它在主机上运行，如图 2-3 所示。用户不能直接与守护进程交互，而是所有的指令都必须通过 Docker 客户端发送。

Docker 客户端:

Docker 客户端可以安装在与 Docker 守护程序相同的主机上，也可以安装在不同的主机上。它是 Docker 守护进程的主要接口。它接受来自用户的命令，并将其发送到 Docker 守护进程执行，并将输出提供给用户。

要理解 Docker，你需要了解它的三个内部组件。他们是，

1.  码头工人图像
2.  坞站注册表
3.  码头集装箱。

![](../images/00014.jpeg)

图 2-4: Docker 组件

Docker 图像:

Docker 图像就像一个黄金模板。一个映像由操作系统(Ubuntu、centos 等)组成。，)和安装在其上的应用程序。这些图像被称为基础图像。Docker 基本映像是 Docker 容器的构建块，从中可以创建容器。可以使用 Docker 内置工具从头开始构建映像。您还可以使用其他用户从 Docker public registry (Docker hub)创建的 Docker 映像作为您的容器的基础映像。

坞站注册表:

Docker registry 是 Docker 图像的存储库。可以是公有的，也可以是私有的。由 Docker 维护的公共 Docker 注册中心称为 Docker hub。用户可以从 Docker 注册表上传和下载图像。公共 Docker 注册表拥有大量官方和用户创建的图像。要创建容器，您可以使用其他用户创建的公共图像，也可以通过将图像上传到公共或私有注册表来使用您自己的图像。

码头集装箱:

容器不仅仅是应用程序的目录和执行环境。它是在 Docker 映像之上创建的，并且是完全隔离的。每个容器都有自己的用户空间、网络和安全设置。容器保存运行应用程序所需的所有文件和配置。可以创建、运行、启动、移动和删除容器。

到目前为止，我们已经了解了 Docker 架构及其组件。现在让我们看看所有的组件是如何组合在一起使 Docker 工作的。

码头工人形象工作:

我们已经学习了码头工人形象的基本概念。在这一节中，我们将了解 Docker 图像是如何工作的。

每个 Docker 图像都是不同层的关联。这种分层方法为创建 Docker 图像提供了一种很好的抽象方式。这些层使用统一文件系统(AUFS)组合成一个单元。AUFS 存储每一层作为一个正常的目录，AUFS 元数据文件。这确保了所有文件和目录对于特定层是唯一的。AUFS 通过组合与映像相关的所有层来创建装载点。对图像的任何更改都将被写入最顶层。

这就是码头集装箱重量很轻的原因。

例如，当您对现有应用程序进行更新时，Docker 要么在现有映像上创建一个层，要么更新现有层。新创建的层将引用其先前的层。Docker 不会像虚拟机一样为应用程序重新构建整个映像。当您将新的更新映像推送到注册表时，它不会重新分发整个映像，而是仅更新现有基础映像之上的层。这使得 Docker 可以快速地从现有的映像创建新的应用程序。

![](../images/00015.jpeg)

图 2-5: Docker 图像

要记住的要点

每个 Docker 映像都有一个基础映像(例如:ubuntu、centos、fedora、debian 等。,)

您可以使用自己的图像作为应用程序的基础图像。假设你有一个安装了 mySQL 的 ubuntu 镜像。您可以将它用作所有数据库容器的基础映像。

名为 Dockerfile 的配置文件以描述的形式保存了构建新映像的指令。Dockerfile 将有运行命令、创建目录、从主机添加文件等指令。，我们将在后续章节中详细了解 Docker 文件。

当您从头构建新映像时，基础映像(由用户指定)将从 Docker hub 下载，说明(Dockerfile)中指定的应用程序将创建为基础映像之上的层。然后，您可以将该图像用作应用程序的基础图像。

码头登记处的运作

Docker 注册表用于存储 Docker 图像。可以从 Docker 注册表中推出和拉出图像来启动容器。有两种类型的 Docker 注册表。

1.  公共注册表(Docker hub):它包含官方 Docker 图片和用户创建的图片。
2.  私有注册表:由用户创建的注册表，用于在数据中心存储私有 Docker 映像。您也可以在 Docker hub 中创建一个私有注册表。

注册表中的所有图像都可以使用 Docker 客户端进行搜索。可以将图像下载到 Docker 主机，用于创建容器和新图像。

![](../images/00016.jpeg)

图 2-6:坞站注册表

要记住的要点

1.  任何一个注册到 Docker hub 的人都可以搜索和获取公共图片。可以从 Docker 客户端和 Docker hub web ui 中搜索图像。
2.  私有图像只能由注册管理机构所有者访问，不会出现在公共注册管理机构的搜索结果中。
3.  您可以在 Docker hub 中创建私有注册表。你可以免费创建一个私人注册中心，你需要付费订阅 Docker hub 来创建多个私人注册中心。

容器如何工作:

正如我们之前了解到的，容器是应用程序的执行环境。它包含所有操作系统文件、用户添加的文件和元数据。基本上，容器是从映像启动的，因此在映像上安装和配置的应用程序将在从映像创建的容器上运行。由于映像是只读格式，当启动容器时，将在容器的映像上添加一个读/写层，以便应用程序运行并对其进行更改。

Docker 客户机从 Docker 二进制或 REST API 接收命令来运行容器。运行容器的基本 Docker 命令如下所示。

sudo 坞站运行-i -t ubuntu /bin/bash

当您从 Docker 二进制文件中运行上述命令时，会发生以下情况:

1.  Docker 客户端将通过“Docker run”命令启动。
2.  它告诉守护进程，应该从哪个映像创建容器。在我们的例子中，它是一个 Ubuntu 图像。
3.  “-i”告诉 Docker 守护进程以交互模式运行容器。
4.  “-t”代表交互式会话的 tty 模式。
5.  "/bin/bash "告诉 Docker 守护进程在容器启动时启动 bash shell。

成功执行 Docker run 命令后，Docker 将在后端执行以下操作。

1.  Docker 检查命令中指定的 Docker 映像是否存在于主机本地。如果它存在于本地，Docker 将使用该映像创建一个容器。如果没有，它将从主机上的公共或私有注册表(基于 Docker 主机配置)下载映像。
2.  本地或提取的映像将用于创建新的容器。

![](../images/00018.jpeg)

图 2-7:集装箱的操作。

3.  一旦设置了映像，Docker 将在映像上创建一个读/写文件系统。
4.  然后 Docker 为容器创建必要的网络接口，以便与主机进行交互。
5.  Docker 从地址池中检查可用的 IP 地址，并分配一个给容器。
6.  然后，它执行命令中指定的命令，例如/bin/bash shell
7.  最后，它记录所有的输入/输出和错误，以便用户了解容器的状态。

还有各种与“Docker run”命令相关联的其他动作。我们将在随后的章节中研究它。

在这一节中，我们将看到 Docker 的底层技术，如名称空间、cgroups 和文件系统。

容器基于名称空间的概念。Docker 使用相同的技术来隔离容器执行环境。当您创建 Docker 容器时，Docker 会为它创建名称空间。这些名称空间是容器的主要隔离因素。

容器的每个元素都有自己的名称空间，所有的访问都在该名称空间内。因此，容器元素在其名称空间之外没有任何访问权限。

![](../images/00019.jpeg)

图 2-8: Docker 名称空间和 cgroups。

命名空间:

Docker 使用的名称空间如下:

1.  PID 名称空间:这个名称空间隔离了容器中的所有进程。
2.  Net 命名空间:所有的网络隔离因素都由 net 命名空间负责。
3.  Ipc 名称空间:容器中的进程间通信由 ipc 名称空间管理。
4.  Mnt 名称空间:容器的所有挂载点都由 mnt 名称空间管理。
5.  Uts 名称空间:所有内核和版本都由 uts 名称空间隔离和管理。

控制组(cgroups):

关于 Docker 的一个有趣的事情是，它可以控制一个容器使用的资源量。这个功能是由 Docker 使用 Linux 控制组(cgroups)实现的。除了隔离，cgroups 还可以允许和限制容器使用的可用资源。

例如，您可以限制 web 服务器容器使用的内存量，并为数据库容器提供更多资源。

文件系统:

在这一节中，我们将看到 Docker 支持的各种文件系统。

Docker 的优雅之处在于对分层图像的精心组织。Docker 利用了内核文件系统中的各种特性。选择文件系统取决于您的主机部署。

让我们来看看 Docker 可以使用的每个后端文件系统。